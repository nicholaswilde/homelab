[SERVICE]
    # Core Engine Settings
    Flush           5
    Daemon          Off
    Log_Level       info
    
    # Required for the 'syslog-rfc3164' parser to work
    Parsers_File    /fluent-bit/etc/parsers.conf
    
    # Internal Monitoring (Accessible via Proxmox host on port 2020)
    HTTP_Server     On
    HTTP_Listen     0.0.0.0
    HTTP_Port       2020

[INPUT]
    Name            syslog
    Parser          syslog-rfc3164
    Listen          0.0.0.0
    Port            514
    Mode            tcp
    Tag             syslog.rsyslog

# --- FILTER STAGE 1: Initialize Fields ---
[FILTER]
    Name            modify
    Match           syslog.*
    # Create 'service' from the syslog 'ident' field
    Copy            ident service
    # Set a default level before Lua processing
    Add             level info
        
# --- FILTER STAGE 2: Level Mapping ---
# Maps syslog numerical severity to LogWard string levels (info, warn, error)
[FILTER]
    Name            lua
    Match           syslog.*
    script          /fluent-bit/etc/map_syslog_level.lua
    call            map_syslog_level

[FILTER]
    Name            lua
    Match           syslog.*
    script          /fluent-bit/etc/map_syslog_level.lua
    call            merge_service_name

# --- FILTER STAGE 3: Cleanup & Identification ---
[FILTER]
    Name            record_modifier
    Match           syslog.*
    # Remove original syslog fields to keep the payload clean
    Remove_key      pri
    Remove_key      ident
    Remove_key      pid
    # Add a global identifier if needed
    Record          source_type rsyslog_forwarder

# --- OUTPUT STAGE ---

# 1. Debug Output: Check Docker logs to see the final result
[OUTPUT]
    Name            stdout
    Match           *
    Format          json_lines

# 2. Production Output: LogWard API
[OUTPUT]
    Name            http
    Match           syslog.*
    Host            ${LOGWARD_API_HOST}
    Port            8080
    URI             /api/v1/ingest/single
    Format          json_lines
    Header          X-API-Key ${LOGWARD_API_KEY}
    Header          Content-Type application/json
    # Map the internal timestamp to the 'time' key in ISO8601 format
    Json_date_key   time
    Json_date_format iso8601
    Retry_Limit     3
    tls             Off
