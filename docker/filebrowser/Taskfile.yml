---
version: '3'

dotenv:
  - .env

tasks:
  shell:
    desc: Shell
    cmds:
      - docker exec -it {{ .CONTAINER_NAME }} sh
  backup:
    desc: Backup volume data
    cmds:
      - docker exec {{ .CONTAINER_NAME }}-backup-1 backup
  rm:
    desc: Remove container
    cmds:
      - docker container rm {{ .CONTAINER_NAME }}
      - docker container rm {{ .CONTAINER_NAME }}-backup-1
      - docker volume rm {{ .CONTAINER_NAME }}_data
  export:
    desc: Export the task list
    cmds:
      - task --list > task-list.txt
  watch:
    desc: Watch Docker container logs
    cmds:
      - docker compose logs -f
  pull:
    desc: Pull docker images
    cmds:
      - docker compose pull
  status:
    desc: Docker container status
    cmds:
      - docker container ps
  init:
    desc: Init .env file
    cmds:
      - cp .env.tmpl .env
      - cp settings.json.tmpl settings.json
    ignore_error: true
  decrypt:
    desc: Decrypt .env using SOPS
    cmds:
      - sops -d --input-type dotenv --output-type dotenv .env.enc > .env
      - sops -d --input-type json --output-type json settings.json.enc > settings.json
  encrypt:
    desc: Encrypt .env using SOPS
    cmds:
      - sops -e .env > .env.enc
      - sops -e settings.json > settings.json.enc
  update:
    desc: Update running containers
    cmds:
      - docker compose up --force-recreate --build -d
      - docker image prune -a -f
  up:
    desc: Run Docker compose in the foreground.
    cmds:
      - docker compose up
  up-d:
    desc: Run Docker compose in the background.
    cmds:
      - docker compose up -d --remove-orphans
  restart:
    desc: Restart Docker containers
    cmds:
      - docker compose restart
  upgrade:
    desc: Upgrade Docker containers
    cmds:
      - git pull origin
      - task: update
  stop:
    desc: Stop Docker containers
    cmds:
      - docker compose stop
  default:
    cmds:
      - task -l
    silent: true
