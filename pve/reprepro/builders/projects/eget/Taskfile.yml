# projects/restic/Taskfile.yml
version: '3'

vars:
  ROOT:
    sh: realpath -m "{{.TASKFILE_DIR}}/../.."
  PROJECT_NAME: eget
  REPO_URL: https://github.com/zyedidia/eget.git
  MAIN_PATH: .
  VERSION_TAG: v1.3.4
  DIST_DIR: "{{.ROOT}}/dist"
  BUILD_DIR: "{{.ROOT}}/build"

tasks:
  check:
    desc: Verify the metadata of .deb files for this app only
    env:
      DIST_DIR: "{{.DIST_DIR}}"
    cmds:
      - cmd: |
          echo "Checking artifacts for {{.PROJECT_NAME}} in {{.BUILD_DIR }} ..."
          echo "---------------------------------------------------"
          
          # FIX: Filter by Project Name
          # We use "ls" first to handle the case where no files exist without crashing the loop
          files=$(ls {{.DIST_DIR}}/{{.PROJECT_NAME}}*.deb 2>/dev/null)

          if [ -z "$files" ]; then
            echo "‚ö†Ô∏è  No .deb files found for {{.PROJECT_NAME}}."
            exit 0
          fi

          for f in $files; do
            echo "üì¶ $(basename $f)"
            dpkg --info "$f" | grep -E "^ (Package|Version|Architecture):"
            echo "---------------------------------------------------"
          done
    silent: true
  latest:
    desc: Check the latest version available on GitHub
    cmds:
      - cmd: |
          LATEST=$(git ls-remote --tags --refs --sort="v:refname" {{.REPO_URL}} | tail -n1 | sed 's/.*\///')
          echo "Current Configured Version: {{.VERSION_TAG}}"
          echo "Latest Upstream Version:    $LATEST"
        silent: true
  build:
    desc: Build "{{.PROJECT_NAME}}" (Go)
    # FIX: Define environment variables here. 
    # They are automatically exported to all cmds below.
    env:
      PROJECT_NAME: "{{.PROJECT_NAME}}"
      MAIN_PATH: "{{.MAIN_PATH}}"
      VERSION_TAG: "{{.VERSION_TAG}}"
      BUILD_DIR: "{{.BUILD_DIR}}"
      DIST_DIR: "{{.DIST_DIR}}"
    cmds:
      - echo "Building {{.PROJECT_NAME}}..."
      - rm -rf {{.BUILD_DIR}}/{{.PROJECT_NAME}}
      - git clone --depth 1 --branch {{.VERSION_TAG}} {{.REPO_URL}} {{.BUILD_DIR}}/{{.PROJECT_NAME}}

      - cmd: |
          cd {{.BUILD_DIR}}/{{.PROJECT_NAME}}
          
          # Now we just run the command. The variables are already in the air.
          goreleaser release --config {{.ROOT}}/templates/goreleaser-main.yaml --snapshot --clean --skip=publish

      - mkdir -p {{.ROOT}}/dist
      - mv {{.BUILD_DIR}}/{{.PROJECT_NAME}}/dist/*.deb {{.DIST_DIR}}/
      - echo "‚úÖ Restic build complete."
  default:
    cmds:
      - task -l
    silent: true
